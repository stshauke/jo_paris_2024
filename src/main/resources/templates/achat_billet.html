<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:insert="fragments/headerFragment :: headerFragment">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4 text-secondary">Achat de Billets</h1>

        <!-- Tableau des billets disponibles -->
        <h3 class="text-secondary">Liste des Billets Disponibles</h3>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nom Offre</th>
                    <th>Type</th>
                    <th>Prix</th>
                    <th>Stock</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="billetTableBody">
                <!-- Les billets seront ins√©r√©s dynamiquement -->
            </tbody>
        </table>

        <!-- Tableau du panier -->
        <h3 class="mt-5 text-secondary">Mon Panier</h3>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ID Billet</th>
                    <th>Id Offre</th>
                    <th>Type</th>
                    <th>Prix</th>
                    <th>Quantit√©</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="panierTableBody">
                <!-- Les billets ajout√©s au panier seront affich√©s ici -->
            </tbody>
        </table>

        <!-- Bouton Payer -->
        <div class="text-end mt-3">
            <button id="payer" class="btn btn-success" style="color: #fff;background-color: #28a745;border-color: #28a745;" disabled>Payer</button>
        </div>

        <!-- Bouton Finaliser l'achat -->
        <div class="text-end">
            <button id="finaliserAchat" class="btn btn-primary" style="color: #fff;background-color: #0d6efd;border-color: #0d6efd;" disabled>Finaliser l'Achat</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    console.log(typeof $);
    <script>
        let panier = [];

        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem("jwtToken");
            System.out.println("üì• Token r√©cup√©r√© avant validation: " + token);
            if (!token) {
                alert("Vous devez √™tre connect√© pour acc√©der √† cette page.");
                window.location.href = "/connexion";  // Redirige l'utilisateur vers la page de connexion
                return;
            }

            // V√©rification de la validit√© du token c√¥t√© serveur
            fetch('http://localhost:9090/api/v1/validateToken', {
                method: 'POST',
                headers: {
                    "Authorization": "Bearer " + token
                }
            })
            .then(response => {
                if (!response.ok) {
                    alert("Le token est invalide ou a expir√©. Veuillez vous reconnecter.");
                    window.location.href = "/connexion"; // Rediriger vers la page de connexion
                }
            })
            .then(() => {
                // Si le token est valide, charger les billets
                loadBillets();
            });

            // √âcouter l'√©v√©nement pour finaliser l'achat
            document.getElementById('finaliserAchat').addEventListener('click', function () {
                finaliserAchat();
            });

            // √âcouter l'√©v√©nement pour effectuer le paiement
            document.getElementById('payer').addEventListener('click', function () {
                mockPaiement();
            });
        });

        let offres = {};

        function loadBillets() {
            const token = localStorage.getItem("jwtToken");

            fetch('http://localhost:9090/api/v1/offres/getAllOffres', {
                method: 'GET',
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token // Ajouter le token JWT
                }
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        alert("Acc√®s refus√©. Veuillez vous connecter.");
                        window.location.href = "/connexion"; // Rediriger vers la page de connexion
                    }
                    throw new Error("Erreur de r√©cup√©ration des offres.");
                }
                return response.json();
            })
            .then(data => {
                offres = {};
                data.forEach(offre => {
                    offres[offre.id_offre] = offre.nom_offre;
                });

                fetch('http://localhost:9090/api/v1/billets/getAllBillets', {
                    method: 'GET',
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token // Ajouter le token JWT
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 401) {
                            alert("Acc√®s refus√©. Veuillez vous connecter.");
                            window.location.href = "/connexion"; // Rediriger vers la page de connexion
                        }
                        throw new Error("Erreur de r√©cup√©ration des billets.");
                    }
                    return response.json();
                })
                .then(billets => {
                    const tableBody = document.getElementById('billetTableBody');
                    tableBody.innerHTML = '';

                    billets.forEach(billet => {
                        const nomOffre = offres[billet.id_offre] || 'Inconnu';
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${billet.id_billet}</td>
                            <td>${nomOffre}</td>
                            <td>${billet.type_billet}</td>
                            <td>${billet.prix_billet}</td>
                            <td>${billet.stock}</td>
                            <td>
                                <button class="btn btn-success btn-sm" onclick="ajouterAuPanier(${billet.id_billet}, ${billet.id_offre}, '${billet.type_billet}', ${billet.prix_billet})">
                                    <i class="fas fa-cart-plus"></i> Ajouter au Panier
                                </button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                })
                .catch(error => console.error('Erreur lors du chargement des billets:', error));
            })
            .catch(error => console.error('Erreur lors du chargement des offres:', error));
        }

        function ajouterAuPanier(id, nomOffre, type, prix) {
            // Ajoutez une nouvelle entr√©e dans le panier pour chaque billet s√©lectionn√©
            panier.push({ id, nomOffre, type, prix });
            // Afficher le panier mis √† jour
            afficherPanier();
        }

        function afficherPanier() {
            const tableBody = document.getElementById('panierTableBody');
            tableBody.innerHTML = '';
            panier.forEach(billet => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${billet.id}</td>
                    <td>${billet.nomOffre}</td>
                    <td>${billet.type}</td>
                    <td>${billet.prix}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="retirerDuPanier(${billet.id})">
                            <i class="fas fa-trash-alt"></i> Retirer
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Si le panier est vide, le bouton "Payer" est d√©sactiv√©
            document.getElementById('payer').disabled = panier.length === 0;
            // Si le panier contient des √©l√©ments, le bouton "Payer" est visible
            document.getElementById('payer').hidden = panier.length === 0;
        }

        function retirerDuPanier(id) {
            panier = panier.filter(billet => billet.id !== id);
            afficherPanier();
        }

        function mockPaiement() {
            // Calculer le montant total du panier
            const montantTotal = panier.reduce((total, billet) => total + billet.prix, 0);

            // Envoi de la requ√™te de paiement
            fetch('http://localhost:9090/api/v1/paiement/simuler', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    idVisiteur: 12,  // Remplace par l'ID r√©el du visiteur
                    montant: montantTotal  // Le montant total du panier
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erreur lors de la requ√™te');
                }
                return response.json();
            })
            .then(data => {
                console.log(data);  // Affiche la r√©ponse pour voir le message JSON

                if (data.message && data.message.includes("succ√®s")) {
                    // Si le paiement a r√©ussi, activer le bouton de finalisation
                    document.getElementById('finaliserAchat').disabled = false;
                    alert(`Paiement de ${montantTotal}‚Ç¨ effectu√© avec succ√®s.`);  // Afficher le montant dans l'alerte
                } else {
                    // Si le paiement a √©chou√©, afficher un message d'erreur
                    alert("Le paiement a √©chou√© : " + data.message);
                }
            })
            .catch(error => {
                console.error('Erreur lors du paiement:', error);
                alert("Une erreur est survenue lors du paiement.");
            });
        }

        function finaliserAchat() {
            const token = localStorage.getItem("jwtToken");
            const emailVisiteur = localStorage.getItem("emailVisiteur");

            if (!emailVisiteur || !token) {
                alert("Utilisateur non authentifi√©. Veuillez vous connecter.");
                return;
            }

            fetch(`http://localhost:9090/api/v1/visiteurs/email/${emailVisiteur}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token // Ajout du token
                }
            })
            .then(response => {
                if (!response.ok) {
                    alert("Acc√®s refus√©. Veuillez vous reconnecter.");
                    window.location.href = "/connexion"; // Rediriger vers la page de connexion
                }
                return response.json();
            })
            .then(idVisiteur => {
                const panierDTO = panier.map(billet => ({
                    idVisiteur: idVisiteur,
                    idBillet: billet.id,
                    dateAjout: new Date().toISOString()
                }));

                return fetch('http://localhost:9090/api/v1/paniers/savePanier', {
                    method: 'POST',
                    headers: {
                        "Content-Type": "application/json",
                       
                        "Authorization": "Bearer " + token // Ajout du token
                    },
                    body: JSON.stringify(panierDTO)
                });
            })
            .then(response => response.json())
            .then(data => {
                console.log("Panier ajout√© avec succ√®s:", data);
                panier = [];
                afficherPanier();
                document.getElementById('finaliserAchat').disabled = true;
                loadBillets(); // Recharger les billets apr√®s finalisation
            })
            .catch(error => {
                console.error('Erreur lors de l\'ajout du panier:', error);
                alert("Une erreur est survenue.");
            });
        }
    </script>
</body>
</html>
                       